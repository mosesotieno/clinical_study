{% extends 'base.html' %}

{% block title %}Lab Request - Clinical Study Manager{% endblock %}

{% block page_title %}Laboratory Request{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-flask"></i> Laboratory Request - {{ visit.participant.first_name }} {{ visit.participant.last_name }}
                </h5>
            </div>
            <div class="card-body">
                <!-- Assessment Summary -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6>Doctor's Assessment</h6>
                                <p class="small mb-1"><strong>Chief Complaint:</strong> {{ visit.doctor_questionnaire.chief_complaint|truncatewords:20 }}</p>
                                <p class="small mb-0"><strong>Physical Findings:</strong> {{ visit.doctor_questionnaire.physical_exam_findings|truncatewords:20 }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6>Psychiatry Assessment</h6>
                                <p class="small mb-1"><strong>Mental Status:</strong> {{ visit.psychiatrist_questionnaire.mental_status_exam|truncatewords:20 }}</p>
                                <p class="small mb-0"><strong>Recommendations:</strong> {{ visit.psychiatrist_questionnaire.recommendations|truncatewords:20 }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Participant Info -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <strong>Participant ID:</strong> {{ visit.participant.participant_id }}
                    </div>
                    <div class="col-md-4">
                        <strong>Visit Type:</strong> {{ visit.get_visit_type_display }}
                    </div>
                    <div class="col-md-4">
                        <strong>Age:</strong> {{ visit.participant.date_of_birth|timesince }}
                    </div>
                </div>

                <form method="post" id="labRequestForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">Select Laboratory Tests *</label>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="card-title mb-0">Basic Metabolic Panel</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="cbc" id="cbc">
                                            <label class="form-check-label" for="cbc">
                                                Complete Blood Count (CBC)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="cmp" id="cmp">
                                            <label class="form-check-label" for="cmp">
                                                Comprehensive Metabolic Panel (CMP)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="lipid" id="lipid">
                                            <label class="form-check-label" for="lipid">
                                                Lipid Panel
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="thyroid" id="thyroid">
                                            <label class="form-check-label" for="thyroid">
                                                Thyroid Function Tests (TSH, T4)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="card-title mb-0">Specialized Tests</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="liver" id="liver">
                                            <label class="form-check-label" for="liver">
                                                Liver Function Tests (LFT)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="renal" id="renal">
                                            <label class="form-check-label" for="renal">
                                                Renal Function Tests
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="vitamin_d" id="vitamin_d">
                                            <label class="form-check-label" for="vitamin_d">
                                                Vitamin D Level
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="b12" id="b12">
                                            <label class="form-check-label" for="b12">
                                                Vitamin B12 Level
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="card-title mb-0">Additional Tests</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="urinalysis" id="urinalysis">
                                            <label class="form-check-label" for="urinalysis">
                                                Urinalysis
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="drug_screen" id="drug_screen">
                                            <label class="form-check-label" for="drug_screen">
                                                Drug Screen
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="hba1c" id="hba1c">
                                            <label class="form-check-label" for="hba1c">
                                                Hemoglobin A1c
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input test-checkbox" type="checkbox" name="tests_requested" value="other" id="other">
                                            <label class="form-check-label" for="other">
                                                Other (specify in notes)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Test Panels -->
                        <div class="mt-3">
                            <small class="text-muted">Quick panels:</small>
                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="selectPanel('basic')">Basic Panel</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectPanel('metabolic')">Metabolic Panel</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectPanel('comprehensive')">Comprehensive</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">Clear All</button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="urgency" class="form-label">Urgency *</label>
                        <select class="form-select" id="urgency" name="urgency" required>
                            <option value="">Select Urgency</option>
                            <option value="ROUTINE">Routine</option>
                            <option value="URGENT">Urgent</option>
                            <option value="STAT">Stat (Immediate)</option>
                        </select>
                        <div class="form-text">
                            Routine: Results within 24-48 hours<br>
                            Urgent: Results within 4-6 hours<br>
                            Stat: Results within 1-2 hours
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Clinical Notes & Special Instructions</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Any special instructions, clinical context, or additional test requests..."></textarea>
                        <div class="form-text">Include relevant clinical information for the lab</div>
                    </div>

                    <div class="mb-3">
                        <label for="fasting_required" class="form-label">Fasting Required</label>
                        <select class="form-select" id="fasting_required" name="fasting_required">
                            <option value="no">Not Required</option>
                            <option value="8_hours">8 Hours Fasting</option>
                            <option value="12_hours">12 Hours Fasting</option>
                        </select>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Lab Request Information</h6>
                        <p class="mb-0">
                            Selected tests will be sent to the laboratory. Please ensure all required clinical 
                            information is provided for accurate interpretation of results.
                        </p>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'core:psychiatrist_assessment' visit.id %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left"></i> Back to Psychiatry
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-paper-plane"></i> Submit Lab Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('labRequestForm');
    
    form.addEventListener('submit', function(e) {
        const selectedTests = document.querySelectorAll('input[name="tests_requested"]:checked');
        const urgency = document.getElementById('urgency').value;
        
        if (selectedTests.length === 0) {
            e.preventDefault();
            alert('Please select at least one laboratory test.');
            return false;
        }
        
        if (!urgency) {
            e.preventDefault();
            alert('Please select the urgency level.');
            document.getElementById('urgency').focus();
            return false;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        submitBtn.disabled = true;
    });

    // Update test count display
    function updateTestCount() {
        const selectedTests = document.querySelectorAll('input[name="tests_requested"]:checked');
        const testCount = selectedTests.length;
        const testCountElement = document.getElementById('testCount');
        
        if (!testCountElement) {
            // Create test count display if it doesn't exist
            const testCountDiv = document.createElement('div');
            testCountDiv.id = 'testCount';
            testCountDiv.className = 'mt-2 text-primary fw-bold';
            document.querySelector('.form-label').after(testCountDiv);
        }
        
        document.getElementById('testCount').textContent = `${testCount} test(s) selected`;
    }

    // Add event listeners to all checkboxes
    const checkboxes = document.querySelectorAll('.test-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateTestCount);
    });

    // Initialize test count
    updateTestCount();
});

// Quick test panel selection
function selectPanel(panelType) {
    const panels = {
        'basic': ['cbc', 'cmp'],
        'metabolic': ['cmp', 'lipid', 'thyroid'],
        'comprehensive': ['cbc', 'cmp', 'lipid', 'thyroid', 'liver', 'renal', 'vitamin_d', 'b12']
    };

    // Clear all first
    clearSelection();
    
    // Select tests for the chosen panel
    panels[panelType].forEach(testId => {
        const checkbox = document.getElementById(testId);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    // Trigger change event to update count
    document.querySelectorAll('.test-checkbox').forEach(checkbox => {
        checkbox.dispatchEvent(new Event('change'));
    });
}

function clearSelection() {
    document.querySelectorAll('.test-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Trigger change event to update count
    document.querySelectorAll('.test-checkbox').forEach(checkbox => {
        checkbox.dispatchEvent(new Event('change'));
    });
}

// Auto-save functionality
let autoSaveTimer;
const inputs = document.querySelectorAll('#labRequestForm textarea, #labRequestForm select, #labRequestForm input[type="checkbox"]');

inputs.forEach(input => {
    input.addEventListener('change', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(function() {
            // Save form data to localStorage
            const formData = new FormData(document.getElementById('labRequestForm'));
            const data = {
                tests: [],
                urgency: formData.get('urgency'),
                notes: formData.get('notes'),
                fasting_required: formData.get('fasting_required')
            };
            
            formData.getAll('tests_requested').forEach(test => {
                data.tests.push(test);
            });
            
            localStorage.setItem('labRequestDraft', JSON.stringify(data));
            console.log('Lab request draft saved');
        }, 2000);
    });
});

// Load draft from localStorage
const savedDraft = localStorage.getItem('labRequestDraft');
if (savedDraft) {
    const draftData = JSON.parse(savedDraft);
    
    // Restore checkboxes
    if (draftData.tests) {
        draftData.tests.forEach(testId => {
            const checkbox = document.getElementById(testId);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }
    
    // Restore other fields
    if (draftData.urgency) {
        document.getElementById('urgency').value = draftData.urgency;
    }
    if (draftData.notes) {
        document.getElementById('notes').value = draftData.notes;
    }
    if (draftData.fasting_required) {
        document.getElementById('fasting_required').value = draftData.fasting_required;
    }
    
    // Update test count
    document.querySelectorAll('.test-checkbox').forEach(checkbox => {
        checkbox.dispatchEvent(new Event('change'));
    });
    
    console.log('Lab request draft loaded');
}

// Clear draft on successful form submission
document.getElementById('labRequestForm').addEventListener('submit', function() {
    localStorage.removeItem('labRequestDraft');
});
</script>

<style>
.form-label {
    font-weight: 600;
    color: #495057;
}
.card .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}
.form-check-label {
    font-weight: normal;
}
.test-checkbox:checked + .form-check-label {
    font-weight: 600;
    color: #0d6efd;
}
.btn {
    min-width: 120px;
}
</style>
{% endblock %}