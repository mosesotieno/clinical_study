{% extends 'base.html' %}

{% block title %}Psychiatry Assessment - Clinical Study Manager{% endblock %}

{% block page_title %}Psychiatry Assessment{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-brain"></i> Psychiatry Assessment - {{ visit.participant.first_name }} {{ visit.participant.last_name }}
                </h5>
            </div>
            <div class="card-body">
                <!-- Previous Assessments -->
                <div class="alert alert-light border">
                    <h6><i class="fas fa-file-medical"></i> Doctor's Assessment</h6>
                    <p class="mb-1"><strong>Chief Complaint:</strong> {{ visit.doctor_questionnaire.chief_complaint }}</p>
                    <p class="mb-0"><strong>Physical Findings:</strong> {{ visit.doctor_questionnaire.physical_exam_findings|truncatewords:20 }}</p>
                </div>

                <form method="post" id="psychiatryForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="mental_status_exam" class="form-label">Mental Status Examination *</label>
                        <textarea class="form-control" id="mental_status_exam" name="mental_status_exam" rows="4" required placeholder="Appearance, behavior, mood, affect, thought process, cognition..."></textarea>
                        <div class="form-text">Describe appearance, behavior, speech, mood, affect, thought process, thought content, cognition, insight, judgment</div>
                        
                        <!-- Quick Templates -->
                        <div class="mt-2">
                            <small class="text-muted">Quick templates:</small>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="insertTemplate('normal_mse')">Normal MSE</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('depression')">Depression</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('anxiety')">Anxiety</button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="risk_factors" class="form-label">Risk Assessment</label>
                        <textarea class="form-control" id="risk_factors" name="risk_factors" rows="3" placeholder="Suicide risk, violence risk, self-harm, etc..."></textarea>
                        <div class="form-text">Assess for suicide risk, violence risk, self-harm potential, and protective factors</div>
                    </div>

                    <div class="mb-3">
                        <label for="recommendations" class="form-label">Recommendations & Treatment Plan *</label>
                        <textarea class="form-control" id="recommendations" name="recommendations" rows="3" required placeholder="Treatment recommendations, follow-up plan..."></textarea>
                        <div class="form-text">Include medication recommendations, therapy referrals, follow-up schedule, safety planning</div>
                    </div>

                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Risk Assessment Alert</h6>
                        <p class="mb-0">
                            If patient expresses suicidal or homicidal ideation, ensure immediate safety planning 
                            and consider appropriate level of care.
                        </p>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'core:doctor_assessment' visit.id %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left"></i> Back to Doctor
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Complete Assessment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('psychiatryForm');
    
    form.addEventListener('submit', function(e) {
        const mentalStatusExam = document.getElementById('mental_status_exam').value.trim();
        const recommendations = document.getElementById('recommendations').value.trim();
        
        if (!mentalStatusExam) {
            e.preventDefault();
            alert('Please complete the mental status examination.');
            document.getElementById('mental_status_exam').focus();
            return false;
        }
        
        if (!recommendations) {
            e.preventDefault();
            alert('Please provide recommendations and treatment plan.');
            document.getElementById('recommendations').focus();
            return false;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;
    });

    // Auto-save draft functionality
    let autoSaveTimer;
    const inputs = form.querySelectorAll('textarea');
    
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(function() {
                // Save form data to localStorage
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                localStorage.setItem('psychiatryAssessmentDraft', JSON.stringify(data));
                console.log('Auto-save completed');
            }, 3000);
        });
    });

    // Load draft from localStorage
    const savedDraft = localStorage.getItem('psychiatryAssessmentDraft');
    if (savedDraft) {
        const draftData = JSON.parse(savedDraft);
        Object.keys(draftData).forEach(key => {
            const element = document.querySelector(`[name="${key}"]`);
            if (element) {
                element.value = draftData[key];
            }
        });
        console.log('Draft loaded from auto-save');
    }

    // Clear draft on successful form submission
    form.addEventListener('submit', function() {
        localStorage.removeItem('psychiatryAssessmentDraft');
    });
});

// Quick templates for common findings
function insertTemplate(templateType) {
    const templates = {
        'normal_mse': `APPEARANCE: Well-groomed, appropriate attire, good eye contact.
BEHAVIOR: Cooperative, normal psychomotor activity.
SPEECH: Normal rate, rhythm, volume, and quantity.
MOOD: "Okay" or "good".
AFFECT: Congruent, full range, appropriate.
THOUGHT PROCESS: Goal-directed, logical, linear.
THOUGHT CONTENT: No suicidal or homicidal ideation, no paranoid ideation.
COGNITION: Alert and oriented x4, memory intact, attention adequate.
INSIGHT: Good.
JUDGMENT: Intact.`,

        'depression': `APPEARANCE: Disheveled, poor eye contact, slowed movements.
BEHAVIOR: Psychomotor retardation, limited engagement.
SPEECH: Slow, low volume, poverty of speech.
MOOD: "Sad" or "depressed".
AFFECT: Constricted, sad, tearful at times.
THOUGHT PROCESS: Somewhat slowed but logical.
THOUGHT CONTENT: Reports hopelessness, worthlessness. Denies current SI but has passive death wishes.
COGNITION: Concentration impaired, memory intact.
INSIGHT: Fair.
JUDGMENT: Fair.`,

        'anxiety': `APPEARANCE: Fidgety, restless, appears tense.
BEHAVIOR: Hypervigilant, frequent scanning of environment.
SPEECH: Rapid, pressured at times.
MOOD: "Anxious" or "nervous".
AFFECT: Anxious, apprehensive.
THOUGHT PROCESS: Some racing thoughts but logical.
THOUGHT CONTENT: Worries about multiple domains, some catastrophic thinking. No SI/HI.
COGNITION: Attention distracted by anxiety, otherwise intact.
INSIGHT: Good regarding anxiety symptoms.
JUDGMENT: Intact.`
    };

    const textarea = document.getElementById('mental_status_exam');
    if (textarea && templates[templateType]) {
        textarea.value = templates[templateType];
        // Trigger input event for auto-save
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl + S to save draft
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        const event = new Event('input', { bubbles: true });
        document.getElementById('psychiatryForm').dispatchEvent(event);
        alert('Draft saved locally');
    }
});
</script>

<style>
.form-label {
    font-weight: 600;
    color: #495057;
}
.alert h6 {
    margin-bottom: 0.5rem;
}
.card-header {
    border-bottom: none;
}
.btn {
    min-width: 120px;
}
</style>
{% endblock %}