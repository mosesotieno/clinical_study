{% extends 'base.html' %}

{% block title %}Participants - Clinical Study Manager{% endblock %}

{% block page_title %}Study Participants{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{% url 'core:enroll_participant' %}" class="btn btn-sm btn-success">
        <i class="fas fa-user-plus"></i> Enroll New Participant
    </a>
</div>
{% endblock %}

{% block content %}
<div class="card shadow">
    <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">
            <i class="fas fa-users"></i> All Participants ({{ participants.count }})
        </h5>
    </div>
    <div class="card-body">
        <!-- Search and Filter -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search participants..." id="searchInput">
                    <button class="btn btn-outline-secondary" type="button" id="searchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="btn-group float-end">
                    <button class="btn btn-outline-primary btn-sm" onclick="exportToCSV()">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="toggleFilters()">
                        <i class="fas fa-filter"></i> Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Advanced Filters -->
        <div class="row mb-4" id="advancedFilters" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Advanced Filters</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="active">Active Visit</option>
                                    <option value="available">Available</option>
                                    <option value="no-visits">No Visits</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Visit Type</label>
                                <select class="form-select" id="visitTypeFilter">
                                    <option value="">All Types</option>
                                    <option value="baseline">Baseline Only</option>
                                    <option value="followup">Follow-up Only</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Enrollment Date</label>
                                <select class="form-select" id="enrollmentFilter">
                                    <option value="">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if participants %}
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="participantsTable">
                <thead class="table-light">
                    <tr>
                        <th>Participant ID</th>
                        <th>Name</th>
                        <th>Date of Birth</th>
                        <th>Gender</th>
                        <th>Enrollment Date</th>
                        <th>Total Visits</th>
                        <th>Last Visit</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for participant in participants %}
                    <tr>
                        <td>
                            <strong>{{ participant.participant_id }}</strong>
                        </td>
                        <td>
                            {{ participant.first_name }} {{ participant.last_name }}
                        </td>
                        <td>{{ participant.date_of_birth }}</td>
                        <td>{{ participant.get_gender_display }}</td>
                        <td>{{ participant.enrollment_date|date:"M d, Y" }}</td>
                        <td>
                            <span class="badge bg-info">{{ participant.visits.count }}</span>
                        </td>
                        <td>
                            {% with last_visit=participant.visits.last %}
                                {% if last_visit %}
                                    {{ last_visit.visit_date|date:"M d, Y" }}
                                    <br>
                                    <small class="text-muted">{{ last_visit.get_visit_type_display }}</small>
                                {% else %}
                                    <span class="text-muted">No visits</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% if participant.has_active_visit %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-running"></i> Active Visit
                                </span>
                            {% elif participant.visits.count > 0 %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i> Available
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-user"></i> New
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'core:participant_detail' participant.id %}" 
                                   class="btn btn-outline-primary" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'core:create_visit' participant.id %}" 
                                   class="btn btn-outline-success" title="New Visit">
                                    <i class="fas fa-plus"></i>
                                </a>
                                <button class="btn btn-outline-info" title="Quick Actions"
                                        onclick="showQuickActions({{ participant.id }})">
                                    <i class="fas fa-bolt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Previous</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </nav>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Participants Enrolled</h4>
            <p class="text-muted">Get started by enrolling your first participant.</p>
            <a href="{% url 'core:enroll_participant' %}" class="btn btn-success">
                <i class="fas fa-user-plus"></i> Enroll First Participant
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Actions Modal -->
<div class="modal fade" id="quickActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <a href="#" class="btn btn-primary" id="baselineVisitBtn">
                        <i class="fas fa-stethoscope"></i> Baseline Visit
                    </a>
                    <a href="#" class="btn btn-info" id="followup1VisitBtn">
                        <i class="fas fa-redo"></i> 1st Follow-up
                    </a>
                    <a href="#" class="btn btn-secondary" id="followup2VisitBtn">
                        <i class="fas fa-undo"></i> 2nd Follow-up
                    </a>
                    <a href="#" class="btn btn-outline-primary" id="viewDetailsBtn">
                        <i class="fas fa-chart-line"></i> View Progress
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exportToCSV() {
    // Simple CSV export functionality
    alert('CSV export functionality would be implemented here');
}

function toggleFilters() {
    const filters = document.getElementById('advancedFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

let currentParticipantId = null;

function showQuickActions(participantId) {
    currentParticipantId = participantId;
    
    // Update modal buttons with correct URLs
    document.getElementById('baselineVisitBtn').href = `{% url 'core:create_visit' 0 %}`.replace('0', participantId) + '?type=BASELINE';
    document.getElementById('followup1VisitBtn').href = `{% url 'core:create_visit' 0 %}`.replace('0', participantId) + '?type=FOLLOWUP_1';
    document.getElementById('followup2VisitBtn').href = `{% url 'core:create_visit' 0 %}`.replace('0', participantId) + '?type=FOLLOWUP_2';
    document.getElementById('viewDetailsBtn').href = `{% url 'core:participant_detail' 0 %}`.replace('0', participantId);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('quickActionsModal'));
    modal.show();
}

// Simple search functionality
document.getElementById('searchButton').addEventListener('click', function() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#participantsTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('searchButton').click();
    }
});

// Advanced filtering
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('visitTypeFilter').addEventListener('change', applyFilters);
document.getElementById('enrollmentFilter').addEventListener('change', applyFilters);

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#participantsTable tbody tr');
    
    rows.forEach(row => {
        let showRow = true;
        
        // Status filter
        if (statusFilter) {
            const statusBadge = row.cells[7].querySelector('.badge');
            if (statusBadge) {
                if (statusFilter === 'active' && !statusBadge.classList.contains('bg-warning')) {
                    showRow = false;
                } else if (statusFilter === 'available' && !statusBadge.classList.contains('bg-success')) {
                    showRow = false;
                } else if (statusFilter === 'no-visits' && !statusBadge.classList.contains('bg-secondary')) {
                    showRow = false;
                }
            }
        }
        
        row.style.display = showRow ? '' : 'none';
    });
}

// Auto-focus search on page load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchInput').focus();
});
</script>

<style>
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.075);
}
.badge {
    font-size: 0.75em;
}
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}